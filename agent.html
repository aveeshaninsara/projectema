<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMA Agent Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary: #4CAF50;
            --on-primary: #FFFFFF;
            --surface: #F5F5F5;
            --on-surface: #212121;
            --surface-variant: #E0E0E0;
            --outline: #BDBDBD;
            --error: #F44336;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Roboto, Arial, sans-serif; }
        body { background-color: var(--surface); color: var(--on-surface); min-height: 100vh; padding: 16px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); padding: 20px; margin-bottom: 20px; }
        h1, h2 { color: var(--primary); margin-bottom: 16px; }
        .btn { padding: 10px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: var(--primary); color: var(--on-primary); }
        .btn-secondary { background-color: var(--surface-variant); color: var(--on-surface); }
        .btn-danger { background-color: var(--error); color: var(--on-primary); }
        .input-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 4px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--outline); border-radius: 4px; }
        .hidden { display: none !important; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .report-card { border: 1px solid var(--outline); border-radius: 8px; padding: 16px; }
        .report-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .report-meta { font-size: 0.8em; color: #666; }
        .report-content { margin: 10px 0; }
        .report-image { max-width: 100%; height: auto; border-radius: 4px; margin-top: 8px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
        #map-modal-content { width: 90%; max-width: none; height: 80%; }
        #agent-map { height: 400px; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        .status-pending { background-color: #ffeb3b; color: #000; }
        .status-accepted { background-color: #4caf50; color: white; }
        .status-declined { background-color: #f44336; color: white; }
        .action-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .decline-form { margin-top: 15px; }
        .decline-form textarea { margin-bottom: 10px; }
        #agent-stats { display: flex; justify-content: space-around; text-align: center; margin-bottom: 20px; }
        #agent-stats div { padding: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1><i class="fas fa-user-shield"></i> EMA Agent Dashboard</h1>
            <div id="login-section">
                <h2>Login</h2>
                <div class="input-group">
                    <label for="agent-id">Agent ID</label>
                    <input type="text" id="agent-id" placeholder="Enter your Agent ID">
                </div>
                <button class="btn btn-primary" id="login-btn"><i class="fas fa-sign-in-alt"></i> Login</button>
                <p id="login-error" class="error hidden"></p>
            </div>
            <div id="dashboard-section" class="hidden">
                <div class="header">
                    <h2>Welcome, <span id="agent-name-display"></span> (<span id="agent-district-display"></span>)</h2>
                    <button class="btn btn-secondary" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
                <div id="agent-stats">
                    <div>Pending: <span id="pending-count">0</span></div>
                    <div>Accepted: <span id="accepted-count">0</span></div>
                    <div>Declined: <span id="declined-count">0</span></div>
                </div>
                <div class="input-group">
                    <label for="report-filter">Filter Reports:</label>
                    <select id="report-filter">
                        <option value="all">All Reports</option>
                        <option value="pending">Pending</option>
                        <option value="accepted">Accepted</option>
                        <option value="declined">Declined</option>
                    </select>
                </div>
                <div id="reports-container">
                    <h2>Reports</h2>
                    <div id="reports-list" class="report-grid">
                        <!-- Reports will be loaded here -->
                        <p>Loading reports...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Detail Modal -->
    <div id="report-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Report Details</h2>
            <div id="report-detail-content">
                <!-- Report details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="map-modal" class="modal">
        <div id="map-modal-content" class="modal-content">
            <span class="close">&times;</span>
            <h2>Report Location</h2>
            <div id="agent-map"></div>
            <p id="map-coordinates"></p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        // --- Firebase Configurations ---
        const userFirebaseConfig = {
            apiKey: "AIzaSyBSwWl0kwwk1mke8OA8ma4jPJTm15RX6dg",
            authDomain: "users-ema.firebaseapp.com",
            databaseURL: "https://users-ema-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "users-ema",
            storageBucket: "users-ema.firebasestorage.app",
            messagingSenderId: "165334149820",
            appId: "1:165334149820:web:e2f3408f2e21808d46beb9",
            measurementId: "G-ZZ04XCWXVQ"
        };

        const reportFirebaseConfig = {
            apiKey: "AIzaSyAib835ipwr_zCw5vMJiy6YgYauGgn2yYg",
            authDomain: "reports-ema.firebaseapp.com",
            databaseURL: "https://reports-ema-default-rtdb.firebaseio.com",
            projectId: "reports-ema",
            storageBucket: "reports-ema.firebasestorage.app",
            messagingSenderId: "843340696456",
            appId: "1:843340696456:web:cbbceec058fb3d53e5883d",
            measurementId: "G-YWEBKKFK6Y"
        };

        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const reportsList = document.getElementById('reports-list');
        const reportDetailModal = document.getElementById('report-detail-modal');
        const mapModal = document.getElementById('map-modal');
        const closeModalButtons = document.querySelectorAll(".close");
        const reportFilter = document.getElementById('report-filter');

        let currentUser = null;
        let allReports = {};
        let agentMap = null;
        let agentMarker = null;

        // Firebase references
        let userDb = null;
        let reportDb = null;

        // --- Initialize App ---
        async function initApp() {
            try {
                // Dynamically import Firebase SDKs
                const { initializeApp: initializeUserApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
                const { getDatabase: getUserDatabase, ref: userRef, get: userGet } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js");

                const { initializeApp: initializeReportApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
                const { getDatabase: getReportDatabase, ref: reportRef, get: reportGet, update: reportUpdate } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js");

                // Initialize Firebase Apps
                const userApp = initializeUserApp(userFirebaseConfig, 'userApp');
                const reportApp = initializeReportApp(reportFirebaseConfig, 'reportApp');

                // Get Database instances
                userDb = getUserDatabase(userApp);
                reportDb = getReportDatabase(reportApp);

                // Make Firebase functions globally available
                window.userRef = userRef;
                window.userGet = userGet;
                window.reportRef = reportRef;
                window.reportGet = reportGet;
                window.reportUpdate = reportUpdate;

                console.log("Agent Dashboard: Firebase initialized.");

                // Set up event listeners
                setupEventListeners();

            } catch (error) {
                console.error("Agent Dashboard: Failed to initialize Firebase:", error);
                alert("Critical Error: Failed to initialize the application. Please check your internet connection and try again.");
            }
        }

        function setupEventListeners() {
            loginBtn.addEventListener('click', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            reportFilter.addEventListener('change', filterReports);
            closeModalButtons.forEach(btn => btn.addEventListener('click', function() {
                reportDetailModal.style.display = "none";
                mapModal.style.display = "none";
            }));
            window.addEventListener('click', function(event) {
                if (event.target == reportDetailModal) reportDetailModal.style.display = "none";
                if (event.target == mapModal) mapModal.style.display = "none";
            });
        }

        // --- Authentication Logic ---
        async function handleLogin() {
            const agentId = document.getElementById('agent-id').value.trim();
            loginError.classList.add('hidden');
            loginError.textContent = '';

            if (!agentId) {
                loginError.textContent = 'Please enter your Agent ID.';
                loginError.classList.remove('hidden');
                return;
            }

            try {
                const agentRef = window.userRef(userDb, `agents/${agentId}`);
                const snapshot = await window.userGet(agentRef);

                if (snapshot.exists()) {
                    currentUser = { agentId, ...snapshot.val() };
                    console.log("Agent Dashboard: Login successful for", currentUser.agentId);
                    showDashboard();
                    loadReports();
                } else {
                    loginError.textContent = 'Invalid Agent ID.';
                    loginError.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Agent Dashboard: Login error:", error);
                loginError.textContent = 'Login failed. Please try again.';
                loginError.classList.remove('hidden');
            }
        }

        function handleLogout() {
            currentUser = null;
            dashboardSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
            document.getElementById('agent-id').value = '';
            reportsList.innerHTML = '<p>Loading reports...</p>';
            allReports = {};
        }

        function showDashboard() {
            document.getElementById('agent-name-display').textContent = currentUser.name || currentUser.agentId;
            document.getElementById('agent-district-display').textContent = currentUser.district || 'N/A';
            loginSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
        }

        // --- Report Management ---
        async function loadReports() {
            if (!reportDb) {
                reportsList.innerHTML = '<p class="error">Database not initialized.</p>';
                return;
            }

            try {
                reportsList.innerHTML = '<p>Loading reports...</p>';
                const reportsRef = window.reportRef(reportDb, 'reports');
                const snapshot = await window.reportGet(reportsRef);
                allReports = snapshot.val() || {};

                updateStats();
                displayReports(Object.values(allReports));

            } catch (error) {
                console.error("Agent Dashboard: Error loading reports:", error);
                reportsList.innerHTML = '<p class="error">Failed to load reports. Please try again.</p>';
            }
        }

        function updateStats() {
            let pending = 0, accepted = 0, declined = 0;
            Object.values(allReports).forEach(report => {
                if (report.status === 'pending') pending++;
                else if (report.status === 'accepted') accepted++;
                else if (report.status === 'declined') declined++;
            });
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('accepted-count').textContent = accepted;
            document.getElementById('declined-count').textContent = declined;
        }

        function filterReports() {
            const filterValue = reportFilter.value;
            let filteredReports = [];

            if (filterValue === 'all') {
                filteredReports = Object.values(allReports);
            } else {
                filteredReports = Object.values(allReports).filter(r => r.status === filterValue);
            }

            displayReports(filteredReports);
        }

        function displayReports(reportsToDisplay) {
            reportsList.innerHTML = '';

            if (!reportsToDisplay || reportsToDisplay.length === 0) {
                reportsList.innerHTML = '<p>No reports found.</p>';
                return;
            }

            // Filter by agent's district if needed (assuming agents only see their district's pending reports)
            // For now, showing all reports based on filter/status
            const sortedReports = reportsToDisplay.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            sortedReports.forEach(report => {
                const reportElement = createReportCard(report);
                reportsList.appendChild(reportElement);
            });
        }

        function createReportCard(report) {
            const card = document.createElement('div');
            card.className = 'report-card';
            card.dataset.reportId = report.id; // Assuming report.id is passed or derived

            const timestamp = new Date(report.timestamp);
            const formattedDate = timestamp.toLocaleDateString();
            const formattedTime = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            card.innerHTML = `
                <div class="report-header">
                    <strong>${report.userName || 'Unknown User'} (${report.userId})</strong>
                    <span class="status-badge status-${report.status}">${report.status.toUpperCase()}</span>
                </div>
                <div class="report-meta">
                    <div>${formattedDate} ${formattedTime}</div>
                    <div>District: ${report.district}</div>
                    <div>Elephants: ${report.numElephants}</div>
                </div>
                <div class="report-content">
                    <p><strong>Location:</strong> Lat: ${report.location.lat.toFixed(6)}, Lng: ${report.location.lng.toFixed(6)}</p>
                    ${report.description ? `<p><strong>Description:</strong> ${report.description.substring(0, 100)}${report.description.length > 100 ? '...' : ''}</p>` : ''}
                </div>
                ${report.image ? `<img src="${report.image}" alt="Report Image" class="report-image" style="max-height: 150px;">` : ''}
                <button class="btn btn-secondary view-details-btn" data-report-id="${report.id}"><i class="fas fa-eye"></i> View Details</button>
            `;
            card.querySelector('.view-details-btn').addEventListener('click', () => openReportDetails(report));
            if (report.image) {
                card.querySelector('.report-image').addEventListener('click', () => openImageZoom(report.image));
            }
            return card;
        }

        function openReportDetails(report) {
            const content = document.getElementById('report-detail-content');
            const timestamp = new Date(report.timestamp);
            const formattedDate = timestamp.toLocaleDateString();
            const formattedTime = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            content.innerHTML = `
                <p><strong>User:</strong> ${report.userName || 'N/A'} (${report.userId || 'N/A'})</p>
                <p><strong>District:</strong> ${report.district}</p>
                <p><strong>Location:</strong> Lat: ${report.location.lat.toFixed(6)}, Lng: ${report.location.lng.toFixed(6)}</p>
                <p><strong>Elephants:</strong> ${report.numElephants}</p>
                ${report.elephantNames ? `<p><strong>Names:</strong> ${report.elephantNames}</p>` : ''}
                <p><strong>Submitted:</strong> ${formattedDate} ${formattedTime}</p>
                ${report.description ? `<p><strong>Description:</strong> ${report.description}</p>` : ''}
                ${report.image ? `<img src="${report.image}" alt="Report Image" class="report-image" style="cursor:pointer;" onclick="openImageZoom('${report.image}')">` : ''}
                <p><strong>Status:</strong> <span class="status-badge status-${report.status}">${report.status.toUpperCase()}</span></p>
                <div class="action-buttons">
                    ${report.status === 'pending' ? `
                        <button class="btn btn-primary" onclick="acceptReport('${report.id}')"><i class="fas fa-check"></i> Accept</button>
                        <button class="btn btn-danger" onclick="openDeclineForm('${report.id}')"><i class="fas fa-times"></i> Decline</button>
                    ` : ''}
                </div>
                <div id="decline-form-${report.id}" class="decline-form hidden">
                    <label for="decline-reason-${report.id}">Reason for Declining:</label>
                    <textarea id="decline-reason-${report.id}" rows="3" placeholder="Enter reason..."></textarea>
                    <button class="btn btn-danger" onclick="declineReport('${report.id}')"><i class="fas fa-paper-plane"></i> Submit Decline</button>
                </div>
            `;
            reportDetailModal.style.display = "block";
        }

        function openImageZoom(imageUrl) {
             const zoomWindow = window.open("", "_blank", "width=800,height=600");
             zoomWindow.document.write(`
                 <html>
                 <head><title>Zoomed Image</title></head>
                 <body style="margin:0; padding:0; display:flex; justify-content:center; align-items:center; height:100vh; background-color:#000;">
                     <img src="${imageUrl}" style="max-width:100%; max-height:100%; object-fit:contain;" />
                 </body>
                 </html>
             `);
             zoomWindow.document.close();
        }


        async function acceptReport(reportId) {
            if (!reportDb || !reportId) return;
            try {
                const reportRef = window.reportRef(reportDb, `reports/${reportId}`);
                await window.reportUpdate(reportRef, { status: 'accepted' });
                console.log(`Report ${reportId} accepted.`);
                alert("Report accepted.");
                reportDetailModal.style.display = "none";
                loadReports(); // Reload to reflect changes
            } catch (error) {
                console.error("Agent Dashboard: Error accepting report:", error);
                alert("Failed to accept report. Please try again.");
            }
        }

        function openDeclineForm(reportId) {
            const form = document.getElementById(`decline-form-${reportId}`);
            if (form) form.classList.toggle('hidden');
        }

        async function declineReport(reportId) {
            if (!reportDb || !reportId) return;
            const reasonInput = document.getElementById(`decline-reason-${reportId}`);
            const reason = reasonInput ? reasonInput.value.trim() : '';
            if (!reason) {
                alert("Please provide a reason for declining.");
                return;
            }

            try {
                const reportRef = window.reportRef(reportDb, `reports/${reportId}`);
                await window.reportUpdate(reportRef, { status: 'declined', declineReason: reason });
                console.log(`Report ${reportId} declined.`);
                alert("Report declined.");
                reportDetailModal.style.display = "none";
                loadReports(); // Reload to reflect changes
            } catch (error) {
                console.error("Agent Dashboard: Error declining report:", error);
                alert("Failed to decline report. Please try again.");
            }
        }

        window.acceptReport = acceptReport;
        window.openDeclineForm = openDeclineForm;
        window.declineReport = declineReport;
        window.openImageZoom = openImageZoom;

        // Initialize the app when the DOM is fully loaded
        window.addEventListener('DOMContentLoaded', () => {
            initApp();
        });
    </script>
</body>
</html>
