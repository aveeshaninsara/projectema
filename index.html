<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMA - Elephant Monitoring App</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --md-sys-color-primary: #606c38;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #e9f4c7;
            --md-sys-color-on-primary-container: #1d2000;
            --md-sys-color-secondary: #5f614d;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #e4e5c1;
            --md-sys-color-on-secondary-container: #1b1d0c;
            --md-sys-color-surface: #fafdf6;
            --md-sys-color-on-surface: #1b1c18;
            --md-sys-color-outline: #75796c;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-shadow: #000000;
            --md-sys-color-surface-variant: #e1e4d5;
            --md-sys-color-on-surface-variant: #44483d;
            --md-sys-elevation-1: 0 1px 2px 0 rgba(0, 0, 0, 0.3), 0 1px 3px 1px rgba(0, 0, 0, 0.15);
            --md-sys-elevation-2: 0 1px 2px 0 rgba(0, 0, 0, 0.3), 0 2px 6px 2px rgba(0, 0, 0, 0.15);
            --md-sys-shape-corner-none: 0px;
            --md-sys-shape-corner-extra-small: 4px;
            --md-sys-shape-corner-small: 8px;
            --md-sys-shape-corner-medium: 12px;
            --md-sys-shape-corner-large: 16px;
            --md-sys-shape-corner-extra-large: 28px;
            --md-sys-state-hover-opacity: 0.08;
            --md-sys-state-focus-opacity: 0.12;
            --md-sys-state-pressed-opacity: 0.12;
            --md-sys-state-dragged-opacity: 0.16;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            /* align-items: flex-start;  Center vertically too, but allow scrolling */
            align-items: center;
            padding: 16px;
            /* padding-top: 40px; Removed top padding */
        }

        .screen {
            width: 100%;
            max-width: 500px;
            display: none;
            flex-direction: column;
            gap: 20px;
        }

        .active {
            display: flex;
        }

        .card {
            background-color: white;
            border-radius: var(--md-sys-shape-corner-large);
            box-shadow: var(--md-sys-elevation-1);
            padding: 20px;
            width: 100%;
            /* Added to prevent card from shrinking too much on short screens */
            flex-shrink: 0;
        }

        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            background-color: white;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1s ease-in-out;
        }

        .logo {
            width: 120px;
            height: auto;
        }

        .fade-out {
            opacity: 0 !important;
        }

        h1, h2 {
            color: var(--md-sys-color-primary);
            margin-bottom: 16px;
        }

        h1 {
            font-size: 1.8rem;
            text-align: center; /* Center title */
        }

        h2 {
            font-size: 1.4rem;
        }

        .input-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-medium);
            background-color: var(--md-sys-color-surface);
            font-size: 16px; /* Keep base size for mobile */
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 2px rgba(96, 108, 56, 0.2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            border-radius: var(--md-sys-shape-corner-medium);
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-decoration: none;
            gap: 8px;
            min-height: 48px; /* Minimum touch target size */
        }

        .btn-primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            box-shadow: var(--md-sys-elevation-1);
        }

        .btn-primary:hover {
            background-color: #4a552a;
            box-shadow: var(--md-sys-elevation-2);
        }

        .btn-secondary {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .btn-secondary:hover {
            background-color: #d7d9b0;
        }

        .btn-text {
            background: none;
            border: none;
            color: var(--md-sys-color-primary);
            padding: 8px 4px;
            font-size: 15px;
            cursor: pointer;
            min-height: 40px;
            width: 100%; /* Make text buttons full width on their line */
            text-align: center; /* Center text */
        }

        .btn-text:hover {
            text-decoration: underline;
        }

         .btn-full {
            width: 100%;
        }

        .text-center {
            text-align: center;
        }

        .mt-16 {
            margin-top: 16px;
        }

        .mb-16 {
            margin-bottom: 16px;
        }

        .mt-8 {
            margin-top: 8px;
        }

        .error {
            color: var(--md-sys-color-error);
            font-size: 14px;
            margin-top: 4px;
        }

        .success {
            color: #2e7d32;
            font-size: 14px;
            margin-top: 4px;
        }

        .user-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 0;
        }

        .avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background-color: var(--md-sys-color-primary-container);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            color: var(--md-sys-color-on-primary-container);
            flex-shrink: 0;
        }

        .user-info h3 {
            margin: 0;
            font-size: 17px;
            word-break: break-word;
        }

        .user-info p {
            margin: 3px 0 0;
            color: var(--md-sys-color-on-surface-variant);
            font-size: 13px;
        }

        /* Stats and Features Grid */
        .stats-grid, .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); /* Responsive grid */
            gap: 14px;
            margin-top: 14px;
        }

        .stat-card, .feature-card {
            background-color: var(--md-sys-color-surface-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 14px;
            text-align: center;
            box-shadow: var(--md-sys-elevation-1);
        }

        .stat-card i, .feature-card i {
            font-size: 22px;
            color: var(--md-sys-color-primary);
            margin-bottom: 6px;
        }

        .stat-card .value {
            font-size: 18px;
            font-weight: bold;
            margin: 6px 0;
        }

        .stat-card .label, .feature-card .label {
            font-size: 13px;
            color: var(--md-sys-color-on-surface-variant);
        }

        .features-grid {
             grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Responsive grid for features */
        }

        .feature-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 14px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }

        .feature-card:hover {
            background-color: #d5d8c9;
            transform: translateY(-2px);
        }

        .id-display {
            text-align: center;
            padding: 20px;
        }

        .user-id {
            font-size: 22px;
            font-weight: bold;
            color: var(--md-sys-color-primary);
            word-break: break-all;
            background-color: var(--md-sys-color-primary-container);
            padding: 14px;
            border-radius: var(--md-sys-shape-corner-medium);
            margin: 14px 0;
        }

        .qr-code {
            margin: 20px auto;
            display: block;
            max-width: 100%;
            height: auto;
            width: 180px;
            height: 180px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--md-sys-shape-corner-large);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--md-sys-elevation-2);
        }

        .modal-header {
            padding: 14px 20px;
            border-bottom: 1px solid var(--md-sys-color-outline);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.3rem;
        }

        .modal-body {
            padding: 14px 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .message {
            max-width: 85%;
            padding: 12px 14px;
            border-radius: var(--md-sys-shape-corner-medium);
            position: relative;
            animation: fadeIn 0.3s ease;
            line-height: 1.4;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            align-self: flex-start;
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            border-bottom-left-radius: 4px;
        }

        .typing-indicator {
            display: none;
            align-self: flex-start;
            background-color: var(--md-sys-color-surface-variant);
            padding: 12px 14px;
            border-radius: var(--md-sys-shape-corner-medium);
            border-bottom-left-radius: 4px;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: var(--md-sys-color-on-surface-variant);
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1.3s linear infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.15s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .modal-footer {
            padding: 14px 20px;
            border-top: 1px solid var(--md-sys-color-outline);
            display: flex;
            gap: 8px;
        }

        .modal-footer input {
            flex-grow: 1;
            min-height: 44px;
        }

        .modal-footer .btn {
            min-width: 44px;
            min-height: 44px;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 360px) {
            body {
                padding: 12px;
                /* padding-top: 30px; */
            }
            .card {
                padding: 16px;
            }
            .btn {
                padding: 10px 16px;
            }
            .stat-card, .feature-card {
                /* min-width: 100px; */
                padding: 12px;
            }
            .modal-content {
                max-height: 95vh;
            }
        }
    </style>
</head>
<body>
    <!-- Startup Screen -->
    <div id="startup-screen" class="logo-container">
        <img src="https://i.ibb.co/jvN2hV16/logo.png" alt="EMA Logo" class="logo">
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="screen">
        <div class="card">
            <h1>Welcome to EMA</h1>
            <div class="input-group">
                <label for="login-id">Enter Your ID</label>
                <input type="text" id="login-id" placeholder="EMA-XXXXXX">
                <div id="login-error" class="error hidden"></div>
            </div>
            <button id="access-app-btn" class="btn btn-primary btn-full">
                <i class="fas fa-sign-in-alt"></i> Access App
            </button>
            <button id="register-btn" class="btn btn-secondary btn-full mt-16">
                <i class="fas fa-user-plus"></i> New User? Register
            </button>
            <button id="guest-btn" class="btn btn-text">
                <i class="fas fa-user-secret"></i> Continue as Guest
            </button>
            <button id="forgot-id-btn" class="btn btn-text">
                <i class="fas fa-question-circle"></i> Forgot ID?
            </button>
        </div>
    </div>

    <!-- Registration Screen -->
    <div id="register-screen" class="screen">
        <div class="card">
            <h1>Register</h1>
            <div class="input-group">
                <label for="full-name">Full Name</label>
                <input type="text" id="full-name" placeholder="Enter your full name">
                <div id="name-error" class="error hidden"></div>
            </div>
            <div class="input-group">
                <label for="province">Province</label>
                <select id="province">
                    <option value="">Select Province</option>
                    <option value="Western">Western</option>
                    <option value="Central">Central</option>
                    <option value="Southern">Southern</option>
                    <option value="Northern">Northern</option>
                    <option value="Eastern">Eastern</option>
                    <option value="North Western">North Western</option>
                    <option value="North Central">North Central</option>
                    <option value="Uva">Uva</option>
                    <option value="Sabaragamuwa">Sabaragamuwa</option>
                </select>
                <div id="province-error" class="error hidden"></div>
            </div>
            <div class="input-group">
                <label for="district">District</label>
                <select id="district" disabled>
                    <option value="">Select District</option>
                </select>
                <div id="district-error" class="error hidden"></div>
            </div>
            <div class="input-group">
                <label for="mobile">Mobile Number</label>
                <input type="tel" id="mobile" placeholder="0771234567">
                <div id="mobile-error" class="error hidden"></div>
            </div>
            <button id="generate-id-btn" class="btn btn-primary btn-full">
                <i class="fas fa-id-card"></i> Generate My ID
            </button>
            <button id="back-to-login-btn" class="btn btn-text mt-16">
                <i class="fas fa-arrow-left"></i> Back to Login
            </button>
        </div>
    </div>

    <!-- ID Display Screen -->
    <div id="id-display-screen" class="screen">
        <div class="card id-display">
            <h1>Your EMA ID</h1>
            <p>Save this ID for future access</p>
            <div id="user-id-display" class="user-id"></div>
            <img id="qr-code" class="qr-code" alt="QR Code">
            <button id="download-id-btn" class="btn btn-primary btn-full mt-16">
                <i class="fas fa-download"></i> Download ID Card
            </button>
            <button id="use-id-btn" class="btn btn-text mt-16">
                Use This ID Now
            </button>
        </div>
    </div>

    <!-- Home Screen -->
    <div id="home-screen" class="screen">
        <div class="card">
            <div class="user-header">
                <div class="avatar" id="user-avatar">U</div>
                <div class="user-info">
                    <h3 id="home-user-name">User Name</h3>
                    <p id="home-user-id">EMA-XXXXXX</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-file-alt"></i>
                    <div class="value">12</div>
                    <div class="label">Reports</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-elephant"></i>
                    <div class="value">8</div>
                    <div class="label">Elephants</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-map-marker-alt"></i>
                    <div class="value">5</div>
                    <div class="label">Locations</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-bell"></i>
                    <div class="value">3</div>
                    <div class="label">Alerts</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Features</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <i class="fas fa-bullhorn"></i>
                    <div class="label">Report Elephant</div>
                </div>
                <div class="feature-card">
                    <i class="fas fa-map-marked-alt"></i>
                    <div class="label">View Map</div>
                </div>
                <div class="feature-card">
                    <i class="fas fa-history"></i>
                    <div class="label">History</div>
                </div>
                <div class="feature-card">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="label">Alerts</div>
                </div>
                <div class="feature-card">
                    <i class="fas fa-user"></i>
                    <div class="label">Profile</div>
                </div>
                <div class="feature-card">
                    <i class="fas fa-cog"></i>
                    <div class="label">Settings</div>
                </div>
            </div>
        </div>

        <div class="card text-center">
            <button id="logout-btn" class="btn btn-primary btn-full">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- AI Assistant Modal -->
    <div id="ai-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>EMA ID Recovery</h2>
                <button id="close-modal-btn" class="btn btn-text">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="chat-messages" id="chat-messages">
                    <!-- Messages will be added here dynamically -->
                </div>
                <div class="typing-indicator" id="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="modal-footer">
                <input type="text" id="user-message" placeholder="Type your message...">
                <button id="send-message-btn" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase configuration - CHECK THIS CAREFULLY
        const firebaseConfig = {
            apiKey: "AIzaSyBSwWl0kwwk1mke8OA8ma4jPJTm15RX6dg",
            authDomain: "users-ema.firebaseapp.com",
            databaseURL: "https://users-ema-default-rtdb.asia-southeast1.firebasedatabase.app", // Ensure NO trailing space
            projectId: "users-ema",
            storageBucket: "users-ema.firebasestorage.app",
            messagingSenderId: "165334149820",
            appId: "1:165334149820:web:e2f3408f2e21808d46beb9",
            measurementId: "G-ZZ04XCWXVQ"
        };

        // DOM Elements
        const screens = {
            startup: document.getElementById('startup-screen'),
            login: document.getElementById('login-screen'),
            register: document.getElementById('register-screen'),
            idDisplay: document.getElementById('id-display-screen'),
            home: document.getElementById('home-screen')
        };

        const modal = document.getElementById('ai-modal');
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const userMessageInput = document.getElementById('user-message');

        // District data
        const districts = {
            "Western": ["Colombo", "Gampaha", "Kalutara"],
            "Central": ["Kandy", "Matale", "Nuwara Eliya"],
            "Southern": ["Galle", "Matara", "Hambantota"],
            "Northern": ["Jaffna", "Kilinochchi", "Mannar", "Vavuniya", "Mullaitivu"],
            "Eastern": ["Batticaloa", "Ampara", "Trincomalee"],
            "North Western": ["Kurunegala", "Puttalam"],
            "North Central": ["Anuradhapura", "Polonnaruwa"],
            "Uva": ["Badulla", "Monaragala"],
            "Sabaragamuwa": ["Ratnapura", "Kegalle"]
        };

        // OpenRouter API Key
        const OPENROUTER_API_KEY = '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';

        // Session data
        let currentUser = null;
        let conversationHistory = [];

        // AI Security State
        let aiState = {
            awaitingMobile: true,
            awaitingConfirmation: false,
            foundUser: null,
            confirmationType: null // 'name' or 'province'
        };

        // Firebase references (will be initialized after SDK loads)
        let db;

        // Initialize app after Firebase SDK loads
        async function initApp() {
             try {
                // Dynamically import Firebase SDKs
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
                const { getDatabase, ref, get, set, query, orderByChild, equalTo } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js");

                // Initialize Firebase
                const app = initializeApp(firebaseConfig);
                db = getDatabase(app);

                // Make Firebase functions globally available for use in handlers
                window.firebaseRef = ref;
                window.firebaseGet = get;
                window.firebaseSet = set;
                window.firebaseQuery = query;
                window.firebaseOrderByChild = orderByChild;
                window.firebaseEqualTo = equalTo;

                // Show startup screen
                setTimeout(() => {
                    screens.startup.classList.add('fade-out');
                    setTimeout(() => {
                        screens.startup.style.display = 'none';
                        showScreen('login');
                    }, 1000);
                }, 2000);

                // Set up event listeners
                setupEventListeners();

                // Populate districts
                const provinceSelect = document.getElementById('province');
                const districtSelect = document.getElementById('district');

                provinceSelect.addEventListener('change', function() {
                    const selectedProvince = this.value;
                    districtSelect.innerHTML = '<option value="">Select District</option>';

                    if (selectedProvince && districts[selectedProvince]) {
                        districts[selectedProvince].forEach(district => {
                            const option = document.createElement('option');
                            option.value = district;
                            option.textContent = district;
                            districtSelect.appendChild(option);
                        });
                        districtSelect.disabled = false;
                    } else {
                        districtSelect.disabled = true;
                    }
                });

                // Initialize AI chat
                initAIChat();

            } catch (error) {
                console.error("Failed to load Firebase SDK:", error);
                alert("Failed to initialize the application. Please check your internet connection and try again.");
                screens.startup.style.display = 'none';
                showScreen('login');
                setupEventListeners();
                initAIChat();
            }
        }

        // Initialize AI Chat with welcome message
        function initAIChat() {
            chatMessages.innerHTML = '';
            resetAIState();
            // Add initial AI message
            addMessageToChat("Hello! I'm the EMA ID Recovery Assistant. Please tell me your registered mobile number (e.g., 0771234567).", 'ai');
        }

        function resetAIState() {
            aiState = {
                awaitingMobile: true,
                awaitingConfirmation: false,
                foundUser: null,
                confirmationType: null
            };
             conversationHistory = [
                {
                    role: 'system',
                    content: 'You are a friendly and helpful assistant for the Elephant Monitoring App (EMA). Your job is to help users recover their EMA ID securely. Strictly follow this process: 1. Ask the user for their registered mobile number (format: 0XXXXXXXXX). 2. When they provide it, you will check the database. 3. If found, you will ask them to confirm either the first letter of their full name OR the first three letters of their province for security. 4. Only after they provide the correct confirmation detail should you reveal their EMA ID. Always be polite and encouraging. If they seem frustrated, offer reassurance. If they ask about anything else, gently remind them you are here to help recover their ID and ask for their mobile number.'
                }
            ];
        }

        // Screen navigation
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenName].classList.add('active');
            window.scrollTo(0, 0);
        }

        // Event listeners
        function setupEventListeners() {
            document.getElementById('access-app-btn').addEventListener('click', handleLogin);
            document.getElementById('register-btn').addEventListener('click', () => showScreen('register'));
            document.getElementById('guest-btn').addEventListener('click', handleGuestLogin);
            document.getElementById('forgot-id-btn').addEventListener('click', () => {
                modal.classList.add('active');
                initAIChat();
                setTimeout(() => {
                    chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
                }, 100);
            });

            document.getElementById('generate-id-btn').addEventListener('click', handleRegistration);
            document.getElementById('back-to-login-btn').addEventListener('click', () => showScreen('login'));

            document.getElementById('download-id-btn').addEventListener('click', downloadIDCard);
            document.getElementById('use-id-btn').addEventListener('click', () => {
                if (currentUser) {
                    showHomeScreen();
                } else {
                    showScreen('login');
                }
            });

            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            document.getElementById('close-modal-btn').addEventListener('click', () => {
                modal.classList.remove('active');
            });
            document.getElementById('send-message-btn').addEventListener('click', sendUserMessage);
            userMessageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendUserMessage();
                }
            });
        }

        // Login handler
        async function handleLogin() {
             if (!db) {
                alert("Application is not fully loaded. Please wait or refresh the page.");
                return;
            }

            const userId = document.getElementById('login-id').value.trim();
            const errorElement = document.getElementById('login-error');

            if (!userId) {
                showError(errorElement, 'Please enter your ID');
                return;
            }

            try {
                const userRef = window.firebaseRef(db, `users/${userId}`);
                const snapshot = await window.firebaseGet(userRef);

                if (snapshot.exists()) {
                    currentUser = { userId, ...snapshot.val() };
                    sessionStorage.setItem('emaUser', JSON.stringify(currentUser));
                    showHomeScreen();
                } else {
                    showError(errorElement, 'Invalid ID. Please check and try again.');
                }
            } catch (error) {
                console.error("Login error:", error);
                showError(errorElement, 'An error occurred. Please try again.');
            }
        }

        // Guest login
        function handleGuestLogin() {
            currentUser = {
                userId: 'GUEST',
                fullName: 'Guest User',
                province: 'N/A',
                district: 'N/A',
                mobile: 'N/A'
            };
            sessionStorage.setItem('emaUser', JSON.stringify(currentUser));
            showHomeScreen();
        }

        // Registration handler - IMPROVED ERROR HANDLING
        async function handleRegistration() {
             if (!db) {
                alert("Application is not fully loaded. Please wait or refresh the page.");
                return;
            }

            const fullName = document.getElementById('full-name').value.trim();
            const province = document.getElementById('province').value;
            const district = document.getElementById('district').value;
            const mobile = document.getElementById('mobile').value.trim();

            const nameError = document.getElementById('name-error');
            const provinceError = document.getElementById('province-error');
            const districtError = document.getElementById('district-error');
            const mobileError = document.getElementById('mobile-error');

            [nameError, provinceError, districtError, mobileError].forEach(el => {
                el.classList.add('hidden');
                el.textContent = '';
            });

            let isValid = true;

            if (!fullName) {
                showError(nameError, 'Full name is required');
                isValid = false;
            }

            if (!province) {
                showError(provinceError, 'Please select a province');
                isValid = false;
            }

            if (!district) {
                showError(districtError, 'Please select a district');
                isValid = false;
            }

            const mobileRegex = /^0[0-9]{9}$/;
            if (!mobile) {
                showError(mobileError, 'Mobile number is required');
                isValid = false;
            } else if (!mobileRegex.test(mobile)) {
                showError(mobileError, 'Please enter a valid Sri Lankan mobile number (0XXXXXXXXX)');
                isValid = false;
            }

            if (!isValid) return;

            try {
                const usersRef = window.firebaseRef(db, 'users');
                const mobileQuery = window.firebaseQuery(usersRef, window.firebaseOrderByChild('mobile'), window.firebaseEqualTo(mobile));
                const snapshot = await window.firebaseGet(mobileQuery);

                if (snapshot.exists()) {
                    showError(mobileError, 'This mobile number is already registered');
                    return;
                }

                const userId = `EMA-${Math.floor(100000 + Math.random() * 900000)}`;

                const userData = {
                    userId,
                    fullName,
                    province,
                    district,
                    mobile,
                    registeredAt: new Date().toISOString()
                };

                // Attempt to save user data
                await window.firebaseSet(window.firebaseRef(db, `users/${userId}`), userData);

                currentUser = userData;
                showIDScreen(userId);
            } catch (error) {
                console.error("Registration error:", error);
                // Provide more specific error messages
                if (error.code === 'PERMISSION_DENIED') {
                     alert('Registration failed: Permission denied. Please contact the administrator.'); // More specific message
                } else if (error.message && error.message.includes('network')) {
                     alert('Registration failed: Network error. Please check your connection.'); // Network issue
                } else {
                     alert('Registration failed. Please try again later.'); // Generic message
                }
                 // alert('Registration failed. Please try again.'); // Original generic message
            }
        }


        // Show ID screen
        function showIDScreen(userId) {
            document.getElementById('user-id-display').textContent = userId;
            const qrCodeUrl = `https://quickchart.io/qr?text=${encodeURIComponent(userId)}&size=200`;
            document.getElementById('qr-code').src = qrCodeUrl;
            showScreen('idDisplay');
        }

        // Download ID card
        function downloadIDCard() {
            const userId = document.getElementById('user-id-display').textContent;
            const qrCodeSrc = document.getElementById('qr-code').src;

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 300;

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const logo = new Image();
            logo.crossOrigin = "Anonymous";
            logo.onload = function() {
                ctx.drawImage(logo, canvas.width/2 - 50, 20, 100, 100);

                ctx.fillStyle = '#000000';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('EMA ID Card', canvas.width/2, 150);

                ctx.font = '18px Arial';
                ctx.fillText(userId, canvas.width/2, 180);

                const qrCode = new Image();
                qrCode.onload = function() {
                    ctx.drawImage(qrCode, canvas.width/2 - 50, 200, 100, 100);

                    const link = document.createElement('a');
                    link.download = `${userId}_ID_Card.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                };
                qrCode.src = qrCodeSrc;
            };
            logo.src = 'https://i.ibb.co/jvN2hV16/logo.png';
        }

        // Show home screen
        function showHomeScreen() {
            if (!currentUser) {
                currentUser = JSON.parse(sessionStorage.getItem('emaUser'));
            }

            if (currentUser) {
                document.getElementById('home-user-name').textContent = currentUser.fullName;
                document.getElementById('home-user-id').textContent = currentUser.userId;
                const initials = currentUser.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
                document.getElementById('user-avatar').textContent = initials;
                showScreen('home');
            } else {
                showScreen('login');
            }
        }

        // Logout handler
        function handleLogout() {
            currentUser = null;
            sessionStorage.removeItem('emaUser');
            showScreen('login');
        }

        // Show error message
        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }

        // AI Assistant functions - IMPROVED FLOW
        async function sendUserMessage() {
            const message = userMessageInput.value.trim();
            if (!message) return;

            addMessageToChat(message, 'user');
            userMessageInput.value = '';

            typingIndicator.style.display = 'flex';
            chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;

            try {
                if (aiState.awaitingMobile) {
                    const mobileRegex = /0[0-9]{9}/g;
                    const matches = message.match(mobileRegex);

                    if (matches && matches.length > 0) {
                        const mobileNumber = matches[0];
                        const user = await lookupUserByMobile(mobileNumber);

                        if (user) {
                            aiState.foundUser = user;
                            aiState.awaitingMobile = false;

                            aiState.confirmationType = Math.random() > 0.5 ? 'name' : 'province';

                            let confirmationPrompt = "";
                            if (aiState.confirmationType === 'name') {
                                confirmationPrompt = `Found your account! For security, please confirm the first letter of your name is '${user.fullName.charAt(0).toUpperCase()}'.`;
                            } else {
                                confirmationPrompt = `Found your account! For security, please confirm the first three letters of your province are '${user.province.substring(0, 3).toUpperCase()}'.`;
                            }

                            typingIndicator.style.display = 'none';
                            addMessageToChat(confirmationPrompt, 'ai');
                            aiState.awaitingConfirmation = true;
                        } else {
                            typingIndicator.style.display = 'none';
                            addMessageToChat("I couldn't find an account with that number. Please check or register.", 'ai');
                        }
                    } else {
                        // If not a mobile number, guide back to asking for it
                         typingIndicator.style.display = 'none';
                         addMessageToChat("To help you, I need your registered mobile number (e.g., 0771234567).", 'ai');
                    }
                } else if (aiState.awaitingConfirmation) {
                    const user = aiState.foundUser;
                    let isConfirmed = false;

                    if (aiState.confirmationType === 'name') {
                        const firstLetter = user.fullName.charAt(0).toUpperCase();
                        isConfirmed = message.toLowerCase().includes(firstLetter.toLowerCase());
                    } else {
                        const firstThreeLetters = user.province.substring(0, 3).toUpperCase();
                        isConfirmed = message.toLowerCase().includes(firstThreeLetters.toLowerCase());
                    }

                    if (isConfirmed) {
                        typingIndicator.style.display = 'none';
                        addMessageToChat(`Thank you! Your EMA ID is: ${user.userId}`, 'ai');
                        resetAIState(); // Reset for potential new requests in same session
                    } else {
                        typingIndicator.style.display = 'none';
                         addMessageToChat("That didn't match. Please try again or say 'reset' to start over.", 'ai');
                         // Optional: Add a 'reset' command
                         if (message.toLowerCase().includes('reset')) {
                             resetAIState();
                             addMessageToChat("Okay, let's start over. Please tell me your mobile number.", 'ai');
                         }
                    }
                }

            } catch (error) {
                console.error('AI Assistant error:', error);
                typingIndicator.style.display = 'none';
                addMessageToChat('Sorry, I encountered an error. Please try again.', 'ai');
                resetAIState();
            }
        }


        // Add message to chat
        function addMessageToChat(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
        }

        // Lookup user by mobile number
        async function lookupUserByMobile(mobileNumber) {
             if (!db) return null;

            try {
                const usersRef = window.firebaseRef(db, 'users');
                const mobileQuery = window.firebaseQuery(usersRef, window.firebaseOrderByChild('mobile'), window.firebaseEqualTo(mobileNumber));
                const snapshot = await window.firebaseGet(mobileQuery);

                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const userId = Object.keys(users)[0];
                    return { userId, ...users[userId] };
                }
            } catch (error) {
                console.error('Database lookup error:', error);
                 // It's okay to not find a user, but log other errors
                 if (error.code !== 'PERMISSION_DENIED') { // Example of checking specific error
                      console.warn("Lookup issue (might be 'not found'):", error.message);
                 }
            }
            return null;
        }

        // Check for existing session and initialize app
        window.addEventListener('DOMContentLoaded', () => {
            const storedUser = sessionStorage.getItem('emaUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                initApp().then(() => {
                     setTimeout(showHomeScreen, 100);
                });
            } else {
                initApp();
            }
        });
    </script>
</body>
</html>
