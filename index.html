<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>EMA – Elephant Monitoring App</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <!-- QR Code library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      /* Basic Material 3-style mobile-first reset */
      body,
      html {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        background: #f5f5f5;
      }

      .curved {
        border-radius: 12px;
        background: #fff;
        padding: 16px;
        margin: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .center {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .hidden {
        display: none;
      }

      button {
        padding: 12px;
        border: none;
        border-radius: 8px;
        margin: 4px;
        background: #6200ee;
        color: #fff;
        font-size: 1em;
        width: 100%;
      }

      input,
      select {
        width: 96.5%;
        padding: 12px;
        margin: 4px 0;
        border: 1px solid #ccc;
        border-radius: 8px;
      }

      .chat-bubble {
        padding: 12px;
        margin: 6px;
        border-radius: 12px;
        max-width: 80%;
      }

      .chat-user {
        background: #e0e0e0;
        align-self: flex-end;
      }

      .chat-ai {
        background: #bbdefb;
        align-self: flex-start;
      }

      .typing {
        font-style: italic;
        color: #777;
      }

      .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div id="splash" class="center" style="height:100vh;background:#0;color:#000;">
      <img id="logo" src="https://i.ibb.co/jvN2hV16/logo.png" style="opacity:0;transition:opacity 1s;max-width:30%;">
    </div>
    <div id="login-screen" class="curved hidden">
      <h2 class="center">Welcome to EMA</h2>
      <input type="text" id="emaIdInput" placeholder="Enter Your EMA ID">
      <button id="accessBtn">
        <i class="fas fa-right-to-bracket"></i> Access App </button>
      <button id="registerBtn">
        <i class="fas fa-user-plus"></i> New User? Register </button>
      <button id="guestBtn">
        <i class="fas fa-user-secret"></i> Continue as Guest </button>
      <button id="forgotBtn">
        <i class="fas fa-question-circle"></i> Forgot ID? </button>
    </div>
    <div id="register-screen" class="curved hidden">
      <h2>Register</h2>
      <input type="text" id="nameInput" placeholder="Full Name">
      <input type="tel" id="phoneInput" placeholder="Mobile (e.g. 0712345678)">
      <select id="provinceSelect">
        <option value="">Select Province</option>
        <option value="Central">Central</option>
        <option value="Eastern">Eastern</option>
        <option value="North Central">North Central</option>
        <option value="Northern">Northern</option>
        <option value="North Western">North Western</option>
        <option value="Sabaragamuwa">Sabaragamuwa</option>
        <option value="Southern">Southern</option>
        <option value="Uva">Uva</option>
        <option value="Western">Western</option>
      </select>
      <select id="districtSelect">
        <option value="">Select District</option>
      </select>
      <input type="file" id="photoInput" accept="image/*">
      <button id="submitReg">
        <i class="fas fa-check"></i> Submit </button>
    </div>
    <div id="chat-screen" class="curved hidden" style="flex-direction:column; height:70vh;">
      <div id="chatHistory" style="flex:1; overflow-y:auto;"></div>
      <div id="typingIndicator" class="typing hidden">...</div>
      <input type="text" id="chatInput" placeholder="Enter your registered mobile number">
      <button id="chatSend">
        <i class="fas fa-paper-plane"></i> Send </button>
    </div>
    <div id="home-screen" class="curved hidden">
      <div class="center">
        <div id="userAvatar" class="curved" style="width:60px;height:60px;display:flex;justify-content:center;align-items:center;">U</div>
        <div id="userIdBadge" style="margin-left:8px;">EMA-XXXXXX</div>
      </div>
      <div class="center">[Stats: Reports / Elephants / Locations / Alerts]</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
        <button>
          <i class="fas fa-paw"></i>
          <br>Report Elephant </button>
        <button>
          <i class="fas fa-map"></i>
          <br>View Map </button>
        <button>
          <i class="fas fa-history"></i>
          <br>History </button>
        <button>
          <i class="fas fa-bell"></i>
          <br>Alerts </button>
        <button>
          <i class="fas fa-user"></i>
          <br>Profile </button>
        <button>
          <i class="fas fa-cog"></i>
          <br>Settings </button>
      </div>
      <button id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout </button>
    </div>
    <!-- Report Popup UI structure placeholders omitted for brevity -->
    <script>
      // Firebase setup
      const firebaseConfig = {
        apiKey: "AIzaSyAsUj0ZJ29uwettrPEVHHCruMUYKpsG5RA",
        authDomain: "ema-data-267e0.firebaseapp.com",
        databaseURL: "https://ema-data-267e0-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "ema-data-267e0",
        storageBucket: "ema-data-267e0.firebasestorage.app",
        messagingSenderId: "301777857122",
        appId: "1:301777857122:web:40f71abdb8c1497dc73f3b",
        measurementId: "G-9Y0SV5VX2Z"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const storage = firebase.storage();
      const splash = document.getElementById('splash');
      const logo = document.getElementById('logo');
      const loginScreen = document.getElementById('login-screen');
      const registerScreen = document.getElementById('register-screen');
      const chatScreen = document.getElementById('chat-screen');
      const homeScreen = document.getElementById('home-screen');
      window.onload = () => {
        logo.style.opacity = 1;
        setTimeout(() => {
          splash.classList.add('hidden');
          loginScreen.classList.remove('hidden');
        }, 2000);
      };
      // Phone validation: Sri Lankan mobile starting with "07" + 7 digits
      document.getElementById('registerBtn').onclick = () => {
        loginScreen.classList.add('hidden');
        registerScreen.classList.remove('hidden');
      };
      document.getElementById('submitReg').onclick = async () => {
        const name = document.getElementById('nameInput').value.trim();
        const phone = document.getElementById('phoneInput').value.trim();
        const province = document.getElementById('provinceSelect').value;
        const district = document.getElementById('districtSelect').value;
        const photoFile = document.getElementById('photoInput').files[0];
        if (!name || !phone || !province || !district) {
          alert('Please fill in all required fields!');
          return;
        }
        // Check if phone already exists
        const snapshot = await db.ref('users').orderByChild('phone').equalTo(phone).once('value');
        if (snapshot.exists()) {
          alert('Phone number already registered.');
          return;
        }
        // Generate EMA ID
        const newId = 'EMA-' + Math.random().toString(36).substr(2, 6).toUpperCase();
        // Convert image to base64
        let base64Image = '';
        if (photoFile) {
          base64Image = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result); // base64 string
            reader.onerror = error => reject(error);
            reader.readAsDataURL(photoFile);
          });
        }
        const userData = {
          name,
          phone,
          province,
          district,
          profileImage: base64Image || '', // store base64 string here
          id: newId,
          created: Date.now()
        };
        await db.ref('users/' + newId).set(userData);
        localStorage.setItem('emaUser', newId);
        alert('Registered! Your ID: ' + newId);
        registerScreen.classList.add('hidden');
        homeScreen.classList.remove('hidden');
        document.getElementById('userIdBadge').innerText = newId;
      };
      document.getElementById('accessBtn').onclick = () => {
        const id = document.getElementById('emaIdInput').value.trim();
        if (!id) return alert('Enter ID');
        db.ref('users/' + id).get().then(snap => {
          if (snap.exists()) {
            localStorage.setItem('emaUser', id);
            loginScreen.classList.add('hidden');
            homeScreen.classList.remove('hidden');
            document.getElementById('userIdBadge').innerText = id;
          } else {
            alert('ID not found!');
          }
        });
      };
      document.getElementById('forgotBtn').onclick = () => {
        loginScreen.classList.add('hidden');
        chatScreen.classList.remove('hidden');
        chatScreen.querySelector('#chatHistory').innerHTML = '';
      };
      document.getElementById('chatSend').onclick = async () => {
        const inp = document.getElementById('chatInput');
        const text = inp.value.trim();
        if (!text) return;
        const hist = document.getElementById('chatHistory');
        hist.innerHTML += ' < div class = "chat-bubble chat-user" > ' + text + ' < /div>';
        inp.value = '';
        document.getElementById('typingIndicator').classList.remove('hidden');
        // simulate AI processing phone lookup
        setTimeout(async () => {
          document.getElementById('typingIndicator').classList.add('hidden');
          if (validLK(text)) {
            const snap = await db.ref('users').orderByChild('phone').equalTo(text).once('value');
            if (snap.exists()) {
              const userId = Object.keys(snap.val())[0];
              hist.innerHTML += ' < div class = "chat-bubble chat-ai" > Your registered ID is: ' + userId + ' < /div>';
            } else {
              hist.innerHTML += ' < div class = "chat-bubble chat-ai" > No ID found
              for that number. < /div>';
            }
          } else {
            hist.innerHTML += ' < div class = "chat-bubble chat-ai" > Please enter a valid Sri Lankan phone number. < /div>';
          }
          hist.scrollTop = hist.scrollHeight;
        }, 1000);
      };
      document.getElementById('logoutBtn').onclick = () => {
        localStorage.removeItem('emaUser');
        homeScreen.classList.add('hidden');
        loginScreen.classList.remove('hidden');
      };
      // Report submission, alerts, radar, analytics, agent/admin modules, maps, etc., would continue in similar modular JS—plus integration with Leaflet, WorldTimeAPI for timestamp, and push notifications.
      async function getSriLankaTime() {
        const res = await fetch('http://worldtimeapi.org/api/timezone/Asia/Colombo');
        const data = await res.json();
        return data.datetime;
      }
      const provinceDistricts = {
        "Central": ["Kandy", "Matale", "Nuwara Eliya"],
        "Eastern": ["Ampara", "Batticaloa", "Trincomalee"],
        "North Central": ["Anuradhapura", "Polonnaruwa"],
        "Northern": ["Jaffna", "Kilinochchi", "Mannar", "Mullaitivu", "Vavuniya"],
        "North Western": ["Kurunegala", "Puttalam"],
        "Sabaragamuwa": ["Kegalle", "Ratnapura"],
        "Southern": ["Galle", "Hambantota", "Matara"],
        "Uva": ["Badulla", "Monaragala"],
        "Western": ["Colombo", "Gampaha", "Kalutara"]
      };
      document.getElementById('provinceSelect').addEventListener('change', function() {
        const province = this.value;
        const districtSelect = document.getElementById('districtSelect');
        districtSelect.innerHTML = ' < option value = "" > Select District < /option>'; / / Reset
        if (province && provinceDistricts[province]) {
          provinceDistricts[province].forEach(district => {
            const option = document.createElement('option');
            option.value = district;
            option.textContent = district;
            districtSelect.appendChild(option);
          });
        }
      });
    </script>
  </body>
</html>
