<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMA - Elephant Monitoring App</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6750A4;
            --on-primary: #FFFFFF;
            --primary-container: #EADDFF;
            --on-primary-container: #21005D;
            --secondary: #625B71;
            --on-secondary: #FFFFFF;
            --secondary-container: #E8DEF8;
            --on-secondary-container: #1D192B;
            --surface: #FFFBFE;
            --on-surface: #1C1B1F;
            --surface-variant: #E7E0EC;
            --on-surface-variant: #49454F;
            --outline: #79747E;
            --error: #B3261E;
            --on-error: #FFFFFF;
            --shape-corner-small: 8px;
            --shape-corner-medium: 16px;
            --shape-corner-large: 24px;
            --shape-corner-extra-large: 32px;
            --shape-corner-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7f1 100%);
            color: var(--on-surface);
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        /* Startup Screen */
        .startup-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 1s ease, visibility 1s ease;
        }

        .logo {
            width: 200px;
            height: 200px;
            margin-bottom: 30px;
            animation: fadeIn 1s ease;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Main Container */
        .main-container {
            width: 100%;
            max-width: 95%; /* Increased for mobile */
            display: none;
        }

        /* Card Component */
        .card {
            background-color: var(--surface);
            border-radius: var(--shape-corner-extra-large);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            animation: slideUp 0.5s ease;
            border: 1px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(10px);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-title {
            font-size: 22px;
            font-weight: 500;
            margin-bottom: 20px;
            color: var(--primary);
            text-align: center;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--on-surface-variant);
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--outline);
            border-radius: var(--shape-corner-medium);
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-container);
        }

        .btn-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 14px 0;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 46px;
            padding: 0 20px;
            border-radius: var(--shape-corner-full);
            border: none;
            font-family: 'Roboto', sans-serif;
            font-size: 15px;
            font-weight: 500;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #7D5260);
            color: var(--on-primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-text {
            background: none;
            border: none;
            color: var(--primary);
            font-weight: 500;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            text-align: center;
        }

        .btn-text:hover {
            text-decoration: underline;
        }

        .btn-guest {
            background: linear-gradient(135deg, #625B71, #7D5260);
            color: var(--on-secondary);
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 16px 0;
        }

        .divider::before,
        .divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid var(--outline);
        }

        .divider span {
            padding: 0 12px;
            color: var(--on-surface-variant);
            font-size: 14px;
        }

        /* ID Card */
        .id-card {
            background: linear-gradient(135deg, var(--primary-container), var(--secondary-container));
            border-radius: var(--shape-corner-large);
            padding: 16px;
            text-align: center;
            margin: 16px 0;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .id-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--on-primary-container);
        }

        .id-number {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 2px;
            margin: 12px 0;
            color: var(--on-primary-container);
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: var(--shape-corner-medium);
        }

        .qr-code {
            width: 120px;
            height: 120px;
            background: white;
            border-radius: var(--shape-corner-medium);
            margin: 12px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-code img {
            max-width: 100%;
            max-height: 100%;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--surface);
            border-radius: var(--shape-corner-large);
            padding: 20px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--on-surface-variant);
        }

        .alert {
            padding: 12px;
            border-radius: var(--shape-corner-medium);
            margin: 12px 0;
            display: flex;
            align-items: center;
        }

        .alert-error {
            background-color: #F9DEDC;
            color: var(--error);
            border: 1px solid var(--error);
        }

        .alert-success {
            background-color: #E6F4EA;
            color: #137333;
            border: 1px solid #137333;
        }

        .alert-icon {
            margin-right: 10px;
            font-size: 20px;
        }

        /* AI Chat Modal */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 70vh;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            background-color: var(--surface-variant);
            border-radius: var(--shape-corner-medium);
            margin-bottom: 12px;
            max-height: 60vh;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: var(--shape-corner-medium);
            font-size: 14px;
        }

        .user-message {
            background-color: var(--primary-container);
            margin-left: 15%;
        }

        .ai-message {
            background-color: var(--surface);
            margin-right: 15%;
        }

        .chat-input {
            display: flex;
            gap: 8px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            font-size: 14px;
        }

        .chat-input button {
            min-width: 80px;
            padding: 10px;
            font-size: 14px;
        }

        .typing-indicator {
            display: none;
            padding: 10px;
            text-align: center;
            color: var(--on-surface-variant);
            font-size: 14px;
        }

        /* Home Screen */
        .home-screen {
            display: none;
        }

        .user-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-container), var(--secondary-container));
            border-radius: var(--shape-corner-large);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #7D5260);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--on-primary);
            font-size: 20px;
            font-weight: 500;
            margin-right: 12px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .user-id {
            font-size: 12px;
            color: var(--on-surface-variant);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .feature-card {
            background: var(--surface);
            border-radius: var(--shape-corner-large);
            padding: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .feature-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        .feature-icon {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .feature-title {
            font-size: 14px;
            font-weight: 500;
        }

        .stats-container {
            background: linear-gradient(135deg, var(--primary-container), var(--secondary-container));
            border-radius: var(--shape-corner-large);
            padding: 16px;
            margin-bottom: 16px;
        }

        .stats-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--on-surface-variant);
        }

        /* Hidden Class */
        .hidden {
            display: none !important;
        }

        /* Responsive - Mobile Only */
        @media (max-width: 768px) {
            .main-container {
                max-width: 95%;
            }
            
            .card {
                padding: 20px;
            }
            
            .logo {
                width: 150px;
                height: 150px;
            }
            
            .card-title {
                font-size: 22px;
            }
            
            .btn {
                min-height: 46px;
                padding: 0 20px;
                font-size: 15px;
            }
            
            .features-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chat-container {
                height: 75vh;
            }
            
            .chat-messages {
                max-height: 65vh;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 12px;
            }
            
            .card {
                padding: 16px;
            }
            
            .logo {
                width: 120px;
                height: 120px;
            }
            
            .card-title {
                font-size: 20px;
            }
            
            .btn {
                min-height: 44px;
                padding: 0 16px;
                font-size: 14px;
            }
            
            .features-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .feature-card {
                padding: 14px;
            }
            
            .feature-icon {
                font-size: 28px;
            }
            
            .feature-title {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Startup Screen -->
    <div class="startup-screen" id="startupScreen">
        <div class="logo">
            <img src="https://i.ibb.co/jvN2hV16/logo.png" alt="EMA Logo">
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container" id="mainContainer">
        <!-- Login Screen -->
        <div class="card" id="loginScreen">
            <h2 class="card-title">Elephant Monitoring App</h2>
            
            <div class="form-group">
                <label for="userId">Enter Your ID</label>
                <input type="text" id="userId" class="form-control" placeholder="Enter your unique ID">
            </div>
            
            <div class="btn-container">
                <button class="btn btn-primary" id="loginBtn">Access App</button>
                <button class="btn btn-secondary" id="registerLink">New User? Register</button>
                <button class="btn btn-guest" id="guestBtn">Continue as Guest</button>
                <button class="btn-text" id="forgotIdBtn">Forgot ID?</button>
            </div>
        </div>

        <!-- Registration Screen -->
        <div class="card hidden" id="registrationScreen">
            <h2 class="card-title">User Registration</h2>
            
            <div class="form-group">
                <label for="fullName">Full Name</label>
                <input type="text" id="fullName" class="form-control" placeholder="Enter your full name">
            </div>
            
            <div class="form-group">
                <label for="province">Province</label>
                <select id="province" class="form-control">
                    <option value="">Select Province</option>
                    <option value="Western">Western Province</option>
                    <option value="Central">Central Province</option>
                    <option value="Southern">Southern Province</option>
                    <option value="Northern">Northern Province</option>
                    <option value="Eastern">Eastern Province</option>
                    <option value="North Western">North Western Province</option>
                    <option value="North Central">North Central Province</option>
                    <option value="Uva">Uva Province</option>
                    <option value="Sabaragamuwa">Sabaragamuwa Province</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="district">District</label>
                <select id="district" class="form-control">
                    <option value="">Select District</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="mobile">Mobile Number</label>
                <input type="tel" id="mobile" class="form-control" placeholder="0771234567">
            </div>
            
            <div class="btn-container">
                <button class="btn btn-primary" id="registerBtn">Generate My ID</button>
                <button class="btn-text" id="backToLogin">Back to Login</button>
            </div>
        </div>

        <!-- ID Display Screen -->
        <div class="card hidden" id="idScreen">
            <h2 class="card-title">Your Unique ID</h2>
            
            <div class="id-card">
                <div class="id-title">EMA USER ID</div>
                <div class="id-number" id="generatedId">EMA-XXXXXX</div>
                <div class="qr-code" id="qrCode">
                    <span>Generating QR...</span>
                </div>
                <p>Save this ID for future access</p>
            </div>
            
            <div class="btn-container">
                <button class="btn btn-primary" id="downloadBtn">Download ID Card</button>
                <button class="btn-text" id="useIdBtn">Use This ID Now</button>
            </div>
        </div>
    </div>

    <!-- Home Screen -->
    <div class="main-container home-screen" id="homeScreen">
        <div class="user-header">
            <div class="user-avatar" id="homeUserAvatar">U</div>
            <div class="user-info">
                <div class="user-name" id="homeUserName">User Name</div>
                <div class="user-id" id="homeUserId">EMA-XXXXXX</div>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="stats-title">Your Activity</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="reportsCount">0</div>
                    <div class="stat-label">Reports</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="elephantsCount">0</div>
                    <div class="stat-label">Elephants</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="locationsCount">0</div>
                    <div class="stat-label">Locations</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="alertsCount">0</div>
                    <div class="stat-label">Alerts</div>
                </div>
            </div>
        </div>
        
        <div class="features-grid">
            <div class="feature-card" id="reportFeature">
                <div class="feature-icon">add_location</div>
                <div class="feature-title">Report Elephant</div>
            </div>
            <div class="feature-card" id="mapFeature">
                <div class="feature-icon">map</div>
                <div class="feature-title">View Map</div>
            </div>
            <div class="feature-card" id="historyFeature">
                <div class="feature-icon">history</div>
                <div class="feature-title">History</div>
            </div>
            <div class="feature-card" id="alertsFeature">
                <div class="feature-icon">notifications</div>
                <div class="feature-title">Alerts</div>
            </div>
            <div class="feature-card" id="profileFeature">
                <div class="feature-icon">person</div>
                <div class="feature-title">Profile</div>
            </div>
            <div class="feature-card" id="settingsFeature">
                <div class="feature-icon">settings</div>
                <div class="feature-title">Settings</div>
            </div>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-primary" id="logoutBtn">Logout</button>
        </div>
    </div>

    <!-- Modal for Alerts -->
    <div class="modal" id="alertModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Alert</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div id="modalMessage"></div>
        </div>
    </div>

    <!-- AI Chat Modal -->
    <div class="modal" id="aiChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">EMA AI Assistant</h3>
                <button class="close-modal" id="closeAiChatModal">&times;</button>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai-message">
                        Hello! I'm the EMA AI Assistant. I can help you recover your ID or reset your password. Please provide your registered mobile number.
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    AI is typing...
                </div>
                <div class="chat-input">
                    <input type="text" id="aiMessageInput" class="form-control" placeholder="Enter your message...">
                    <button class="btn btn-primary" id="sendAiMessage">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBSwWl0kwwk1mke8OA8ma4jPJTm15RX6dg",
            authDomain: "users-ema.firebaseapp.com",
            databaseURL: "https://users-ema-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "users-ema",
            storageBucket: "users-ema.firebasestorage.app",
            messagingSenderId: "165334149820",
            appId: "1:165334149820:web:e2f3408f2e21808d46beb9",
            measurementId: "G-ZZ04XCWXVQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make Firebase available globally
        window.firebaseDatabase = database;

        // DOM Elements
        const startupScreen = document.getElementById('startupScreen');
        const mainContainer = document.getElementById('mainContainer');
        const loginScreen = document.getElementById('loginScreen');
        const registrationScreen = document.getElementById('registrationScreen');
        const idScreen = document.getElementById('idScreen');
        const homeScreen = document.getElementById('homeScreen');
        
        const registerLink = document.getElementById('registerLink');
        const backToLogin = document.getElementById('backToLogin');
        const useIdBtn = document.getElementById('useIdBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const guestBtn = document.getElementById('guestBtn');
        const forgotIdBtn = document.getElementById('forgotIdBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        
        const provinceSelect = document.getElementById('province');
        const districtSelect = document.getElementById('district');
        const generatedIdElement = document.getElementById('generatedId');
        const qrCodeElement = document.getElementById('qrCode');

        // AI Chat Elements
        const aiChatModal = document.getElementById('aiChatModal');
        const closeAiChatModal = document.getElementById('closeAiChatModal');
        const chatMessages = document.getElementById('chatMessages');
        const aiMessageInput = document.getElementById('aiMessageInput');
        const sendAiMessage = document.getElementById('sendAiMessage');
        const typingIndicator = document.getElementById('typingIndicator');

        // Home screen elements
        const homeUserAvatar = document.getElementById('homeUserAvatar');
        const homeUserName = document.getElementById('homeUserName');
        const homeUserId = document.getElementById('homeUserId');

        // Modal elements
        const alertModal = document.getElementById('alertModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const closeModal = document.getElementById('closeModal');

        // Sri Lanka districts by province
        const districtsByProvince = {
            "Western": ["Colombo", "Gampaha", "Kalutara"],
            "Central": ["Kandy", "Matale", "Nuwara Eliya"],
            "Southern": ["Galle", "Matara", "Hambantota"],
            "Northern": ["Jaffna", "Kilinochchi", "Mannar"],
            "Eastern": ["Trincomalee", "Batticaloa", "Ampara"],
            "North Western": ["Kurunegala", "Puttalam"],
            "North Central": ["Anuradhapura", "Polonnaruwa"],
            "Uva": ["Badulla", "Moneragala"],
            "Sabaragamuwa": ["Ratnapura", "Kegalle"]
        };

        // AI Conversation context
        let aiConversation = [
            {
                role: "system",
                content: "You are the EMA (Elephant Monitoring App) AI Assistant. Your only purpose is to help users recover their IDs or reset passwords. You must only discuss ID recovery and password reset procedures. Do not provide any other information. If a user asks about anything else, politely redirect them to ID recovery or password reset. Always verify the user's identity by asking for their registered mobile number before providing any sensitive information. When a user provides their mobile number, check if it exists in the Firebase database. If it exists, provide their ID. If not, ask them to verify the number."
            }
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Show startup screen for 2 seconds
            setTimeout(() => {
                startupScreen.style.opacity = '0';
                setTimeout(() => {
                    startupScreen.style.visibility = 'hidden';
                    mainContainer.style.display = 'block';
                    loginScreen.classList.remove('hidden');
                }, 1000);
            }, 2000);

            // Province change handler
            provinceSelect.addEventListener('change', function() {
                const province = this.value;
                districtSelect.innerHTML = '<option value="">Select District</option>';
                
                if (province && districtsByProvince[province]) {
                    districtsByProvince[province].forEach(district => {
                        const option = document.createElement('option');
                        option.value = district;
                        option.textContent = district;
                        districtSelect.appendChild(option);
                    });
                }
            });

            // Event Listeners
            registerLink.addEventListener('click', showRegistration);
            backToLogin.addEventListener('click', showLogin);
            useIdBtn.addEventListener('click', showLogin);
            downloadBtn.addEventListener('click', downloadIDCard);
            guestBtn.addEventListener('click', loginAsGuest);
            forgotIdBtn.addEventListener('click', () => {
                // Directly open AI chat when user clicks Forgot ID
                aiChatModal.classList.add('active');
            });
            logoutBtn.addEventListener('click', logout);
            
            // AI Chat Event Listeners
            closeAiChatModal.addEventListener('click', () => {
                aiChatModal.classList.remove('active');
            });
            sendAiMessage.addEventListener('click', sendAiMessageToOpenRouter);
            aiMessageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendAiMessageToOpenRouter();
                }
            });
            
            document.getElementById('loginBtn').addEventListener('click', loginUser);
            document.getElementById('registerBtn').addEventListener('click', registerUser);
            
            // Modal event listeners
            closeModal.addEventListener('click', () => {
                alertModal.classList.remove('active');
            });
            
            alertModal.addEventListener('click', (e) => {
                if (e.target === alertModal) {
                    alertModal.classList.remove('active');
                }
            });
            
            aiChatModal.addEventListener('click', (e) => {
                if (e.target === aiChatModal) {
                    aiChatModal.classList.remove('active');
                }
            });
        });

        // Show registration screen
        function showRegistration() {
            loginScreen.classList.add('hidden');
            registrationScreen.classList.remove('hidden');
        }

        // Show login screen
        function showLogin() {
            registrationScreen.classList.add('hidden');
            idScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        // User login
        async function loginUser() {
            const userId = document.getElementById('userId').value.trim();
            
            if (!userId) {
                showAlert('Error', 'Please enter your ID', 'error');
                return;
            }

            try {
                // Check if ID exists in Firebase
                const db = window.firebaseDatabase;
                const userRef = ref(db, 'users/' + userId);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    // Save user data to session storage
                    sessionStorage.setItem('currentUser', JSON.stringify(userData));
                    showHomeScreen(userData);
                } else {
                    showAlert('Error', 'ID not found. Please check your ID or register as a new user.', 'error');
                }
            } catch (error) {
                console.error('Error checking ID:', error);
                showAlert('Error', 'Failed to verify ID. Please try again.', 'error');
            }
        }

        // Login as guest
        function loginAsGuest() {
            // Create guest user data
            const guestData = {
                userId: 'GUEST',
                fullName: 'Guest User',
                province: 'N/A',
                district: 'N/A',
                mobile: 'N/A'
            };
            
            // Save to session storage
            sessionStorage.setItem('currentUser', JSON.stringify(guestData));
            showHomeScreen(guestData);
        }

        // User registration
        async function registerUser() {
            const fullName = document.getElementById('fullName').value.trim();
            const province = document.getElementById('province').value;
            const district = document.getElementById('district').value;
            const mobile = document.getElementById('mobile').value.trim();

            // Validation
            if (!fullName || !province || !district || !mobile) {
                showAlert('Error', 'Please fill in all fields', 'error');
                return;
            }

            if (!/^0[0-9]{9}$/.test(mobile)) {
                showAlert('Error', 'Please enter a valid Sri Lankan mobile number', 'error');
                return;
            }

            try {
                // Check if mobile number already exists
                const db = window.firebaseDatabase;
                const mobileQuery = query(ref(db, 'users'), orderByChild('mobile'), equalTo(mobile));
                const mobileSnapshot = await get(mobileQuery);
                
                if (mobileSnapshot.exists()) {
                    showAlert('Error', 'This mobile number is already registered. Please use another number.', 'error');
                    return;
                }

                // Generate unique ID
                const userId = generateUniqueID();
                generatedIdElement.textContent = userId;
                
                // Save to Firebase
                await set(ref(db, 'users/' + userId), {
                    fullName: fullName,
                    province: province,
                    district: district,
                    mobile: mobile,
                    userId: userId,
                    registeredAt: new Date().toISOString()
                });
                
                // Generate QR code
                generateQRCode(userId);
                
                // Show ID screen
                registrationScreen.classList.add('hidden');
                idScreen.classList.remove('hidden');
            } catch (error) {
                console.error('Error during registration:', error);
                showAlert('Error', 'Registration failed. Please try again.', 'error');
            }
        }

        // Generate unique ID
        function generateUniqueID() {
            const prefix = "EMA";
            const randomNum = Math.floor(100000 + Math.random() * 900000);
            return `${prefix}-${randomNum}`;
        }

        // Generate QR code
        function generateQRCode(text) {
            // Using QuickChart.io API for QR code generation
            const qrUrl = `https://quickchart.io/qr?text=${encodeURIComponent(text)}&size=200`;
            qrCodeElement.innerHTML = `<img src="${qrUrl}" alt="QR Code">`;
        }

        // Download ID Card
        function downloadIDCard() {
            const id = generatedIdElement.textContent;
            const qrImg = qrCodeElement.querySelector('img');
            
            if (!qrImg) {
                showAlert('Error', 'QR code not available for download', 'error');
                return;
            }
            
            // Create a canvas to combine elements
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.crossOrigin = "Anonymous";
            img.onload = function() {
                canvas.width = 400;
                canvas.height = 300;
                
                // Background
                const gradient = ctx.createLinearGradient(0, 0, 400, 300);
                gradient.addColorStop(0, '#EADDFF');
                gradient.addColorStop(1, '#E8DEF8');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 400, 300);
                
                // Border
                ctx.strokeStyle = '#6750A4';
                ctx.lineWidth = 4;
                ctx.strokeRect(0, 0, 400, 300);
                
                // Title
                ctx.fillStyle = '#21005D';
                ctx.font = 'bold 24px Roboto';
                ctx.textAlign = 'center';
                ctx.fillText('EMA USER ID', 200, 50);
                
                // ID
                ctx.fillStyle = '#21005D';
                ctx.font = 'bold 32px Roboto';
                ctx.fillText(id, 200, 100);
                
                // QR Code
                ctx.drawImage(img, 125, 120, 150, 150);
                
                // Footer
                ctx.fillStyle = '#21005D';
                ctx.font = '16px Roboto';
                ctx.fillText('Elephant Monitoring App', 200, 290);
                
                // Download
                const link = document.createElement('a');
                link.download = `EMA-ID-${id}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showAlert('Success', 'ID card downloaded successfully!', 'success');
            };
            
            img.src = qrImg.src;
        }

        // Show home screen
        function showHomeScreen(userData) {
            // Hide all screens
            mainContainer.style.display = 'none';
            loginScreen.classList.add('hidden');
            registrationScreen.classList.add('hidden');
            idScreen.classList.add('hidden');
            
            // Show home screen
            homeScreen.style.display = 'block';
            
            // Update user info
            const firstLetter = userData.fullName.charAt(0).toUpperCase();
            homeUserAvatar.textContent = firstLetter;
            homeUserName.textContent = userData.fullName;
            homeUserId.textContent = userData.userId;
        }

        // Logout
        function logout() {
            sessionStorage.removeItem('currentUser');
            homeScreen.style.display = 'none';
            mainContainer.style.display = 'block';
            loginScreen.classList.remove('hidden');
            document.getElementById('userId').value = '';
        }

        // Send message to OpenRouter AI with better model
        async function sendAiMessageToOpenRouter() {
            const message = aiMessageInput.value.trim();
            if (!message) return;

            // Add user message to chat
            addMessageToChat('user', message);
            aiMessageInput.value = '';

            // Show typing indicator
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // Add user message to conversation context
                aiConversation.push({ role: "user", content: message });

                // Call OpenRouter API with a more reliable model
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": "Bearer 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",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "mistralai/mistral-7b-instruct", // More reliable model
                        messages: aiConversation,
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.choices && data.choices.length > 0) {
                    const aiResponse = data.choices[0].message.content;
                    
                    // Add AI response to conversation context
                    aiConversation.push({ role: "assistant", content: aiResponse });
                    
                    // Add AI message to chat
                    addMessageToChat('ai', aiResponse);
                    
                    // Check if user provided mobile number and we should look it up
                    if (message.match(/0\d{9}/)) {
                        const mobileNumber = message.match(/0\d{9}/)[0];
                        await lookupUserIdByMobile(mobileNumber);
                    }
                } else {
                    addMessageToChat('ai', "Sorry, I couldn't process your request. Please try again.");
                }
            } catch (error) {
                console.error('AI API Error:', error);
                addMessageToChat('ai', "Sorry, I'm having trouble connecting to the AI service. Please try again later.");
            } finally {
                // Hide typing indicator
                typingIndicator.style.display = 'none';
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Lookup user ID by mobile number in Firebase
        async function lookupUserIdByMobile(mobileNumber) {
            try {
                const db = window.firebaseDatabase;
                const mobileQuery = query(ref(db, 'users'), orderByChild('mobile'), equalTo(mobileNumber));
                const mobileSnapshot = await get(mobileQuery);
                
                if (mobileSnapshot.exists()) {
                    const users = mobileSnapshot.val();
                    const userIds = Object.keys(users);
                    
                    if (userIds.length > 0) {
                        const userId = userIds[0];
                        addMessageToChat('ai', `I found your account! Your ID is: ${userId}. Please save this for future access.`);
                    } else {
                        addMessageToChat('ai', "I couldn't find an account with that mobile number. Please verify the number or register as a new user.");
                    }
                } else {
                    addMessageToChat('ai', "I couldn't find an account with that mobile number. Please verify the number or register as a new user.");
                }
            } catch (error) {
                console.error('Firebase lookup error:', error);
                addMessageToChat('ai', "Sorry, I couldn't verify your account information at the moment. Please try again later.");
            }
        }

        // Add message to chat display
        function addMessageToChat(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(role === 'user' ? 'user-message' : 'ai-message');
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Show alert modal
        function showAlert(title, message, type) {
            modalTitle.textContent = title;
            modalTitle.style.color = type === 'error' ? 'var(--error)' : '#137333';
            
            const icon = type === 'error' ? 'error' : 'check_circle';
            const alertClass = type === 'error' ? 'alert-error' : 'alert-success';
            
            modalMessage.innerHTML = `
                <div class="alert ${alertClass}">
                    <span class="material-symbols-outlined alert-icon">${icon}</span>
                    <span>${message}</span>
                </div>
            `;
            
            alertModal.classList.add('active');
        }
    </script>
</body>
</html>
